### 加固、加壳
通常apk经过解压缩可以拿到dex文件，而dex文件经过反编译可以拿到源代码，因此要保护dex文件不被反编译，就需要对dex文件进行加固。加固的原理是将dex文件加密，然后使用一个壳程序来解密dex文件并加载到内存中，这样即使dex文件被反编译，也无法直接获取到源代码。

### 混淆
混淆的目的是为了降低代码的可读性，即使apk被反编译后也可以提高代码的破解难度。同时混淆可以降低代码的字节数，因为代码的命令从业务上的很长一串的命名编程很简短的字母代替。同时也有资源文件的混淆同样保护资源文件被反编译后让破解者无法直接使用。

#### 不适用混淆的规则
1. Android系统组件
Activity、Service、BroadcastReceiver、ContentProvider 等系统组件：这些组件在AndroidManifest.xml文件中进行了声明，因此它们的类名不能改变，否则系统将无法识别并调用它们。
2. 自定义View
如果你的应用中有自定义的View，这些View的类名也需要被保留，因为它们在布局文件中被引用，并且可能需要通过反射来访问其属性或方法。
3. 反射调用的类和方法
如果你的代码中使用了反射来调用某个类的方法或访问其属性，那么这个类及其相关成员（如方法、字段）需要被保留。
4. Parcelable接口的实现类
实现了Parcelable接口的类通常用于Android的进程间通信（IPC），如Intent的额外数据传递。这些类的结构需要被保留，以确保数据的正确序列化和反序列化。
5. 被注解修饰的类和方法
如果你的代码中使用了自定义注解或Android框架提供的注解（如@BindView、@Inject等），并且这些注解需要被反射或其他机制识别，那么被这些注解修饰的类和方法可能需要被保留。
6. 资源引用
与资源文件（如布局文件、字符串资源等）关联的类（如R类）的成员（如常量ID）需要被保留，以确保资源能被正确引用。
7. Native方法
如果你的代码中使用了JNI（Java Native Interface）来调用本地（C/C++）代码，那么包含native方法的类及其方法名需要被保留，因为JNI通过方法名来找到对应的本地实现。
8. 第三方库
如果你的应用依赖了第三方库，并且这些库的某些类或方法需要在你的代码中被显式调用，那么这些类或方法可能需要被保留。通常，第三方库的文档会指出哪些类或方法需要被保留。

### 签名

Android应用签名的作用是为了防止应用被篡改。使用签名信息校验apk文件内容，可以检验处apk文件是否被修改。.apk文件其实是一个zip文件，v1签名会忽略部分内容，而v2签名会校验整个apk文件。

Android 支持以下三种应用签名方案：
* v1 方案：基于 JAR 签名。
* v2 方案：APK 签名方案 v2（在 Android 7.0 中引入）。
* v3 方案：APK 签名方案 v3（在 Android 9 中引入）。

> Zip文件的内容格式如下
<img src="https://pic1.zhimg.com/80/v2-8eebbfa106c836ca4e76ab68352b98b0_720w.webp">

在zip内容和中心路径中间插入签名信息不会影响apk的解压。

v1方案会对zip包里面的所有文件逐个计算SHA1值，然后通过私钥加密这些值，生成签名数据。在验证签名时，会对zip包里面的所有文件逐个计算SHA1值，然后通过公钥解密签名数据，比较计算结果是否和签名数据一致。在验证签名时需要进行解压操作，浪费了时间和性能。v1 签名不保护 APK 的某些部分，例如 ZIP 元数据。

> V1签名的校验流程
<img src="https://pic3.zhimg.com/80/v2-cb935ea898bf6bedcae0a8b073bbb56e_720w.webp" >

v2方案在验证的时候无需对整个apk进行解压，v2方案在zip文件中插入了一个签名块来存放签名的信息，校验签名的时候只需要解压这个签名块即可。在签名时会以1M按照区块来计算摘要，然后根据这些摘要和私钥计算生成签名。最后添加x509证书。

> V2签名的验证过程
<img src="https://pic2.zhimg.com/80/v2-22e97d065a74e7c553fd8e81882d731d_720w.webp" style="width:100%;">

v3方案在v2的基础上，添加了新的签名块，支持签名秘钥的更换。Android 9.0中引入了新的签名方式v3，v3签名在v2的基础上，仍然采用检查整个压缩包的校验方式。不同的是在签名部分增可以添加新的证书（Attr块）。在这个新块中，会记录我们之前的签名信息以及新的签名信息， 支持密钥轮换，即以密钥转轮的方案，来做签名的替换和升级。这意味着，只要旧签名证书在手，应用能够在 APK 更新过程中更改其签名密钥。

v3 签名新增的新块（attr）存储了所有的签名信息，由更小的 Level 块，以链表的形式存储。
> V2和V3签名块的区别
<img src="https://pic2.zhimg.com/80/v2-baaef45cf4e919f5c70d137f42601e95_720w.webp">

由于v2签名时从android7.0开始引入考率到兼容性，兼容低于android7.0的设置，一般会采用v1、v2混合模式一起签名。在高版本提高校验速度，同时兼容了低版本的校验。

### APK体积优化

### 支持32位和64位apk
